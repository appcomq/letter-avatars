base_image: "samsaffron/discourse_base:1.0.12"

update_pups: false

params:
  home: /var/www/letter-avatars
  pngout_url: http://static.jonof.id.au/dl/kenutils/pngout-20150319-linux-static.tar.gz
  pngout: pngout-20150319-linux-static

expose:
  - "80:8080"

env:
  TEMP_FILE_PATH: /shared/cache

volumes:
  - volume:
     host: /var/discourse/shared/letter-avatars
     guest: /shared

run:
    - exec: (cp /shared/pngout-static /usr/bin/pngout)  || (cd /shared && wget $pngout_url && tar -xzvf $pngout.tar.gz && cp /shared/$pngout/i686/pngout-static /shared/pngout-static && cp /shared/pngout-static /usr/bin/pngout)
    - exec:
        cmd:
          - useradd web -s /bin/bash -m -U
    - exec: mkdir -p /shared/cache
    - exec: chown web /shared/cache
    - exec: mkdir -p /var/www
    - exec: cd /var/www && git clone --depth 1 https://github.com/discourse/letter-avatars.git
    - exec:
        cd: $home
        cmd:
          - chown -R web $home
          - mkdir -p /shared/gems
          - chown -R web /shared/gems
          - sudo -E -u web bundle install --path=/shared/gems --verbose
          - sudo -E -u web bundle exec rake
    - file:
       path: /etc/service/puma/run
       chmod: "+x"
       contents: |
         #!/bin/bash
         exec 2>&1
         cd $home
         exec sudo -E -u web LD_PRELOAD=/usr/lib/libjemalloc.so.1 bundle exec puma -p 8080 -e production

